<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
<title>I&#39;m defined</title>
<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/style.css">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CRS2BQJ19C"></script>

<script defer>
  hljs.highlightAll();

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CRS2BQJ19C');
</script>

<meta name="generator" content="Hexo 8.0.0"></head>
<body>
    <header>
<nav>
    <div class="blog-name">
        <a href="/">I'm Defined</a>
    </div>
    <div class="blog-nav">
        <a href="/">首頁</a>
        <a href="/about/">關於我</a>
        <a href="/archives/">文章列表</a>
    </div>
</nav>
</header>
    <main>
        <article class="post-article">
    <header class="post-header">
        <div class="post-meta">
            <span>更新日期：2025-10-25</span>
        </div>
        <h1>Snippy 開發日誌 Day 4</h1>
        <div class="post-content">
            <h2 id="做了這些事情">做了這些事情:</h2>
<p>建立資料庫模組，並且在應用程式載入時，自動初始化。<br>
初始化時，會確定檔案路徑的存在，跟建立目錄、<code>sqlite3.db</code>。<br>
處理<code>better-sqlite3</code>打包的問題，vite 的 Rollup 無法也不需要編譯 <code>better-sqlite3</code>。<br>
然後建立新增Snippet的功能，每次點擊新增，都會在指定目錄建立檔案，以及在資料庫建立該檔案資料。<br>
這種桌面應用，主進程跟渲染進程之間使用 IPC（進程間通訊）溝通。<br>
IPC 概念類似網站的 API，但 IPC 是本地通訊，不走網路，速度更快。</p>
<span id="more"></span>
<h2 id="建立資料庫模組">建立資料庫模組</h2>
<ul>
<li>建立 <code>electron/database.ts</code> 獨立模組</li>
<li>實作初始化函數 <code>initDatabase()</code>（目錄建立 + schema）</li>
<li>整合資料庫初始化至 <code>main.ts</code> 啟動流程</li>
</ul>
<h2 id="修復-better-sqlite3-打包問題">修復 better-sqlite3 打包問題</h2>
<ul>
<li>在 <code>vite.config.js</code> 加入 <code>external: ['better-sqlite3']</code></li>
<li>避免 Rollup 打包 native 模組</li>
</ul>
<h2 id="Create-功能實現">Create 功能實現</h2>
<p><strong>修改檔案：</strong></p>
<ol>
<li><code>electron/database.ts</code>
<ul>
<li>新增 <code>createSnippet()</code> 函式</li>
<li>邏輯：查詢 <code>sqlite_sequence</code> → 生成檔名 → 建立空檔案 → 插入資料庫 → 回傳資料</li>
</ul>
</li>
<li><code>electron/main.ts</code>
<ul>
<li>引入 <code>ipcMain</code> 和 <code>createSnippet</code></li>
<li>註冊 IPC handler: <code>create-snippet</code></li>
</ul>
</li>
<li><code>electron/preload.ts</code>
<ul>
<li>引入 <code>ipcRenderer</code></li>
<li>提供 <code>snippyAPI.createSnippet()</code> 給前端。</li>
</ul>
</li>
<li><code>src/components/ui/AddBtn.vue</code>
<ul>
<li>實作 <code>addNewSnippet()</code> 函式</li>
<li>呼叫 <code>snippyAPI.createSnippet()</code></li>
<li>添加 <code>try-catch</code> 錯誤處理</li>
</ul>
</li>
</ol>
<p><strong>技術要點：</strong></p>
<ul>
<li>檔名規則：未命名_${id}.js（用資料庫 ID 遞增）</li>
<li>預設內容：空檔案</li>
<li>IPC 通訊鏈：AddBtn → preload → main → database</li>
<li>參數綁定防止 SQL injection</li>
</ul>
<p><strong>學習內容：</strong></p>
<ul>
<li>better-sqlite3 API（prepare/get/run/exec）</li>
<li>sqlite_sequence 系統表</li>
<li>IPC 機制（invoke/handle）</li>
<li>TypeScript 類型斷言（as any）</li>
</ul>
<h2 id="TypeScript-使用的型別">TypeScript 使用的型別</h2>
<ul>
<li><code>let db: database.database</code></li>
<li><code>const result = await (window as any).snippyAPI.createSnippet();</code></li>
</ul>

        </div>
    </header>
</article>
    </main>
    <footer>
        <div>
    <p>
        &copy; 2025 Qiu | Powered by Hexo
    </p>
</div>
    </footer>
</body>
</html>